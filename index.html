<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffebee">
    <title>PulseHeart App</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />

    <style>
        :root {
            --primary: #d81b60; --primary-light: #ff4081; 
            --bg: #fff0f6; --card-bg: rgba(255, 255, 255, 0.85);
            --text: #880e4f; --shadow: 0 8px 32px rgba(216, 27, 96, 0.15);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg);
            background-image: radial-gradient(at 0% 0%, #f8bbd0 0, transparent 50%), radial-gradient(at 100% 100%, #f48fb1 0, transparent 50%);
            color: var(--text); font-family: 'Fredoka', sans-serif;
            margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- NAVIGATION SYSTEM --- */
        .page {
            flex: 1; display: none; flex-direction: column; 
            align-items: center; padding: 20px; padding-top: 60px;
            overflow-y: auto; scroll-behavior: smooth;
            animation: fadeIn 0.3s ease;
        }
        .page.active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .nav-bar {
            height: calc(70px + var(--safe-area-bottom));
            background: white; width: 100%;
            border-radius: 30px 30px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            display: flex; justify-content: space-around;
            padding-bottom: var(--safe-area-bottom);
            z-index: 100;
        }

        .nav-item {
            flex: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: #ccc; transition: 0.2s; cursor: pointer;
        }
        .nav-item span { font-size: 30px; margin-bottom: 2px; }
        .nav-item label { font-size: 10px; font-weight: 600; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active span { font-variation-settings: 'FILL' 1; transform: scale(1.1); }

        /* --- PAGE 1: HOME (MONITOR) --- */
        .monitor-ring {
            width: 260px; height: 260px; background: var(--card-bg);
            border-radius: 50%; border: 4px solid white;
            box-shadow: var(--shadow);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            margin-bottom: 30px; position: relative;
        }
        .bpm-val { font-size: 90px; font-weight: 700; color: var(--primary); line-height: 1; z-index: 2; }
        .heart-icon { font-size: 160px; color: var(--primary); opacity: 0.05; position: absolute; z-index: 1; }
        .pump { animation: beat 0.15s ease-out; opacity: 0.3 !important; }
        @keyframes beat { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .graph-box {
            width: 100%; height: 100px; background: white;
            border-radius: 20px; overflow: hidden; margin-bottom: 20px;
            border: 2px solid rgba(255,255,255,0.6);
        }
        canvas { width: 100%; height: 100%; }

        .btn {
            width: 100%; padding: 18px; border: none; border-radius: 25px;
            font-size: 18px; font-weight: 700; color: white;
            background: var(--primary); box-shadow: 0 10px 20px rgba(216, 27, 96, 0.3);
            transition: 0.1s;
        }
        .btn:active { transform: scale(0.96); }
        .btn.stop { background: #d32f2f; }

        /* --- PAGE 2: HISTORY --- */
        .history-list { width: 100%; max-width: 400px; padding-bottom: 20px; }
        .history-card {
            background: white; border-radius: 20px; padding: 15px 20px;
            margin-bottom: 15px; display: flex; align-items: center;
            justify-content: space-between; box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        
        .h-left { display: flex; flex-direction: column; }
        .h-date { font-size: 12px; color: #aaa; margin-bottom: 4px; }
        .h-zone { font-size: 14px; font-weight: bold; color: #555; display: flex; align-items: center; gap: 5px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .h-bpm { font-size: 24px; font-weight: 700; color: var(--primary); }

        .empty-state { text-align: center; color: #aaa; margin-top: 100px; }

        /* --- PAGE 3: PROFILE --- */
        .profile-card {
            background: white; width: 100%; border-radius: 30px;
            padding: 30px; text-align: center; margin-bottom: 20px;
        }
        .avatar { 
            width: 80px; height: 80px; background: #fce4ec; border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; margin: 0 auto 15px;
            color: var(--primary); font-size: 40px;
        }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { font-size: 12px; color: #888; margin-left: 10px; }
        .input-group input {
            width: 100%; padding: 15px; border-radius: 15px; border: 2px solid #fce4ec;
            font-size: 16px; font-family: 'Fredoka'; color: var(--text);
            background: #fff; outline: none;
        }

        /* --- MODAL (ONBOARDING) --- */
        #onboarding {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; text-align: center;
        }

        video { position: absolute; width: 1px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <div id="onboarding" style="display: none;">
        <span class="material-symbols-rounded" style="font-size: 80px; color: var(--primary); margin-bottom: 20px;">health_and_safety</span>
        <h1 style="color: var(--primary); margin: 0;">ยินดีต้อนรับ</h1>
        <p style="color: #666; margin-bottom: 30px;">กรุณากรอกข้อมูลเพื่อเริ่มใช้งาน</p>
        <div style="width: 100%; max-width: 300px;">
            <input type="text" id="setupName" placeholder="ชื่อเล่น" style="width: 100%; padding: 15px; border-radius: 15px; border: 2px solid #f06292; margin-bottom: 15px; text-align: center; font-size: 18px;">
            <input type="number" id="setupAge" placeholder="อายุ" style="width: 100%; padding: 15px; border-radius: 15px; border: 2px solid #f06292; margin-bottom: 25px; text-align: center; font-size: 18px;">
            <button class="btn" onclick="finishSetup()">เริ่มต้นใช้งาน</button>
        </div>
    </div>

    <div id="page-home" class="page active">
        <h2 style="margin: 0; color: var(--primary);">วัดชีพจร</h2>
        <p id="homeUser" style="margin: 5px 0 20px; font-size: 14px; opacity: 0.6;">Ready to measure</p>
        
        <div class="monitor-ring">
            <span class="material-symbols-rounded heart-icon" id="heartIcon">favorite</span>
            <div id="bpmDisplay" class="bpm-val">--</div>
            <div style="font-size: 16px; font-weight: 600; opacity: 0.6; z-index: 2;">BPM</div>
        </div>

        <div class="graph-box"><canvas id="graphCanvas"></canvas></div>
        <button id="actionBtn" class="btn" onclick="toggleMeasure()">เริ่มวัด (START)</button>
    </div>

    <div id="page-history" class="page">
        <h2 style="margin: 0 0 20px; color: var(--primary);">ประวัติการวัด</h2>
        <div id="historyList" class="history-list">
            <div class="empty-state">ยังไม่มีข้อมูล</div>
        </div>
        <button class="btn" style="background: #ccc; margin-top: auto;" onclick="clearHistory()">ล้างประวัติ</button>
    </div>

    <div id="page-profile" class="page">
        <h2 style="margin: 0 0 20px; color: var(--primary);">ข้อมูลส่วนตัว</h2>
        <div class="profile-card">
            <div class="avatar"><span class="material-symbols-rounded">person</span></div>
            <div class="input-group">
                <label>ชื่อ</label>
                <input type="text" id="profileName" onchange="saveProfile()">
            </div>
            <div class="input-group">
                <label>อายุ</label>
                <input type="number" id="profileAge" onchange="saveProfile()">
            </div>
            <div class="input-group">
                <label>Max Heart Rate (คำนวณอัตโนมัติ)</label>
                <input type="text" id="profileMaxHR" disabled style="background: #f5f5f5; color: #aaa;">
            </div>
        </div>
        <p style="font-size: 12px; color: #aaa; text-align: center;">PulseHeart v2.0 (Full App)</p>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="navTo('home')">
            <span class="material-symbols-rounded">ecg_heart</span>
            <label>วัดชีพจร</label>
        </div>
        <div class="nav-item" onclick="navTo('history')">
            <span class="material-symbols-rounded">history</span>
            <label>ประวัติ</label>
        </div>
        <div class="nav-item" onclick="navTo('profile')">
            <span class="material-symbols-rounded">person</span>
            <label>โปรไฟล์</label>
        </div>
    </div>

    <video id="video" playsinline></video>

    <script>
        // --- APP STATE ---
        let userData = { name: "", age: 25, history: [] };
        let isRunning = false;
        let rafId;
        
        // --- DOM Elements ---
        const pages = ['home', 'history', 'profile'];
        const video = document.getElementById('video');
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const graphCanvas = document.getElementById('graphCanvas');
        const graphCtx = graphCanvas.getContext('2d');
        
        // --- Initialization ---
        window.onload = function() {
            loadData();
            resizeGraph();
            if(!userData.name) {
                document.getElementById('onboarding').style.display = 'flex';
            } else {
                updateUI();
            }
        };

        function finishSetup() {
            let name = document.getElementById('setupName').value;
            let age = document.getElementById('setupAge').value;
            if(name && age) {
                userData.name = name;
                userData.age = parseInt(age);
                saveData();
                document.getElementById('onboarding').style.display = 'none';
                updateUI();
            } else alert("กรุณากรอกข้อมูลให้ครบ");
        }

        // --- Navigation ---
        function navTo(pageId) {
            // Switch Page
            pages.forEach(p => document.getElementById(`page-${p}`).classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            
            // Switch Icon
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if(pageId === 'history') renderHistory();
            if(pageId === 'profile') updateUI();
        }

        // --- Core Logic (High BPM) ---
        let signalBuffer = new Array(120).fill(0.5);
        let minVal=0, maxVal=0;
        let lastBeatTime=0;
        let bpmBuffer = [];
        let sessionReadings = [];

        async function toggleMeasure() {
            let btn = document.getElementById('actionBtn');
            if(!isRunning) {
                try {
                    let stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: "environment", width: {ideal: 100}, height: {ideal: 100} } 
                    });
                    video.srcObject = stream; await video.play();
                    try { await stream.getVideoTracks()[0].applyConstraints({ advanced: [{ torch: true }] }); } catch(e){}

                    isRunning = true;
                    btn.innerText = "หยุด (STOP)"; btn.classList.add('stop');
                    document.getElementById('bpmDisplay').innerText = "--";
                    bpmBuffer = []; sessionReadings = [];
                    loop();
                } catch(e) { alert("กรุณาเปิดสิทธิ์กล้องใน Settings"); }
            } else {
                stopCamera();
                if(sessionReadings.length > 5) saveHistory();
            }
        }

        function stopCamera() {
            isRunning = false; cancelAnimationFrame(rafId);
            if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
            document.getElementById('actionBtn').innerText = "เริ่มวัดใหม่";
            document.getElementById('actionBtn').classList.remove('stop');
        }

        function loop() {
            if(!isRunning) return;

            // 1. Read
            ctx.drawImage(video, 0, 0, 30, 30);
            let frame = ctx.getImageData(15, 15, 1, 1).data;
            let avg = frame[0]; // Red channel

            // 2. Process (Fast Response)
            if(minVal===0) { minVal=avg; maxVal=avg; }
            minVal = Math.min(minVal, avg); maxVal = Math.max(maxVal, avg);
            minVal += 0.8; maxVal -= 0.8; // Fast decay for sport

            let range = Math.max(1, maxVal - minVal);
            let inverted = 1.0 - ((avg - minVal) / range);

            signalBuffer.push(inverted); if(signalBuffer.length > 120) signalBuffer.shift();
            drawGraph();

            // 3. Detect (Threshold 0.55, Deadzone 260ms = ~230 BPM Max)
            if(inverted > 0.55) {
                let now = Date.now();
                if(now - lastBeatTime > 260) {
                    let bpm = 60 / ((now - lastBeatTime)/1000);
                    lastBeatTime = now;
                    if(bpm > 50 && bpm < 200) updateBPM(Math.round(bpm));
                }
            }
            rafId = requestAnimationFrame(loop);
        }

        function updateBPM(bpm) {
            bpmBuffer.push(bpm); if(bpmBuffer.length > 5) bpmBuffer.shift();
            let avg = Math.round(bpmBuffer.reduce((a,b)=>a+b,0)/bpmBuffer.length);
            
            // Animation
            let icon = document.getElementById('heartIcon');
            icon.classList.remove('pump'); void icon.offsetWidth; icon.classList.add('pump');
            
            document.getElementById('bpmDisplay').innerText = avg;
            
            // Collect for history
            if(bpmBuffer.length >= 5) sessionReadings.push(avg);
        }

        function saveHistory() {
            let sum = sessionReadings.reduce((a,b)=>a+b,0);
            let avg = Math.round(sum/sessionReadings.length);
            let zone = getZone(avg);
            
            let record = {
                date: new Date().toLocaleString('th-TH'),
                bpm: avg,
                zoneName: zone.name,
                zoneColor: zone.color
            };
            
            userData.history.unshift(record); // Add to top
            if(userData.history.length > 20) userData.history.pop(); // Keep last 20
            saveData();
            alert(`บันทึกเรียบร้อย: ${avg} BPM (${zone.name})`);
        }

        // --- Data Management ---
        function saveData() { localStorage.setItem('pulseHeartData', JSON.stringify(userData)); }
        function loadData() {
            let d = localStorage.getItem('pulseHeartData');
            if(d) userData = JSON.parse(d);
        }
        function saveProfile() {
            userData.name = document.getElementById('profileName').value;
            userData.age = parseInt(document.getElementById('profileAge').value);
            saveData();
            updateUI();
        }
        function clearHistory() {
            if(confirm("ลบประวัติทั้งหมด?")) {
                userData.history = [];
                saveData();
                renderHistory();
            }
        }

        // --- UI Rendering ---
        function updateUI() {
            document.getElementById('homeUser').innerText = `สวัสดี, ${userData.name}`;
            document.getElementById('profileName').value = userData.name;
            document.getElementById('profileAge').value = userData.age;
            document.getElementById('profileMaxHR').value = (220 - userData.age) + " BPM";
        }

        function renderHistory() {
            let list = document.getElementById('historyList');
            list.innerHTML = "";
            if(userData.history.length === 0) {
                list.innerHTML = `<div class="empty-state">ยังไม่มีข้อมูลการวัด</div>`;
                return;
            }
            userData.history.forEach(item => {
                let html = `
                <div class="history-card">
                    <div class="h-left">
                        <div class="h-date">${item.date}</div>
                        <div class="h-zone">
                            <span class="dot" style="background:${item.zoneColor}"></span> ${item.zoneName}
                        </div>
                    </div>
                    <div class="h-bpm">${item.bpm} <span style="font-size:12px; color:#aaa;">bpm</span></div>
                </div>`;
                list.innerHTML += html;
            });
        }

        function getZone(bpm) {
            let max = 220 - userData.age;
            let p = (bpm/max)*100;
            if(p<50) return {name:"Warm Up", color:"#4fc3f7"};
            if(p<60) return {name:"Fat Burn", color:"#81c784"};
            if(p<70) return {name:"Cardio", color:"#ffb74d"};
            if(p<80) return {name:"Hard", color:"#e57373"};
            return {name:"Peak", color:"#c62828"};
        }

        function drawGraph() {
            let w = graphCanvas.width = graphCanvas.offsetWidth;
            let h = graphCanvas.height = graphCanvas.offsetHeight;
            graphCtx.clearRect(0,0,w,h);
            graphCtx.strokeStyle = "#d81b60"; graphCtx.lineWidth = 3;
            graphCtx.beginPath();
            let step = w/120;
            for(let i=0; i<signalBuffer.length; i++){
                let y = h - (signalBuffer[i]*h*0.85) - 10;
                if(i===0) graphCtx.moveTo(0,y); else graphCtx.lineTo(i*step, y);
            }
            graphCtx.stroke();
        }
        function resizeGraph() { resizeGraph(); } // Trigger initial size
    </script>
</body>
</html>
