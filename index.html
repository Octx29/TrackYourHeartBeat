<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#e0f7fa">
    <title>PulseHeart Custom</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />

    <style>
        :root {
            /* ธีมสีฟ้า-เขียว (ดูสบายตา สื่อถึงค่าปกติ) */
            --primary: #00838f; --accent: #00acc1; 
            --bg: #e0f7fa; --card-bg: rgba(255, 255, 255, 0.9);
            --text: #006064; --shadow: 0 8px 32px rgba(0, 131, 143, 0.15);
        }

        body {
            background: var(--bg);
            background-image: radial-gradient(at 0% 0%, #b2ebf2 0, transparent 50%), radial-gradient(at 100% 100%, #80deea 0, transparent 50%);
            color: var(--text); font-family: 'Fredoka', sans-serif;
            margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column;
            user-select: none; -webkit-user-select: none;
        }

        /* --- UI COMPONENTS --- */
        .page { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; }
        
        .monitor-ring {
            width: 280px; height: 280px; background: var(--card-bg);
            border-radius: 50%; border: 6px solid white;
            box-shadow: var(--shadow);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            margin-top: 40px; margin-bottom: 30px; position: relative;
            transition: transform 0.1s;
        }
        
        .bpm-val { font-size: 100px; font-weight: 700; color: var(--primary); line-height: 1; z-index: 2; text-shadow: 2px 2px 0px white; }
        .bpm-lbl { font-size: 14px; font-weight: 600; color: #aaa; margin-top: -5px; }
        
        .zone-badge {
            margin-top: 10px; padding: 5px 15px; border-radius: 20px;
            font-size: 14px; font-weight: bold; color: white;
            background: #ccc; transition: 0.3s;
        }

        .graph-box {
            width: 100%; height: 100px; background: white;
            border-radius: 20px; overflow: hidden; margin-bottom: 20px;
            border: 2px solid rgba(255,255,255,0.8);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.02);
        }
        canvas { width: 100%; height: 100%; }

        .btn {
            width: 100%; padding: 18px; border: none; border-radius: 25px;
            font-size: 20px; font-weight: 700; color: white; cursor: pointer;
            background: var(--primary); box-shadow: 0 10px 20px rgba(0, 131, 143, 0.2);
            transition: 0.1s;
        }
        .btn:active { transform: scale(0.96); }
        .btn.stop { background: #ef5350; box-shadow: 0 10px 20px rgba(239, 83, 80, 0.3); }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 15px; text-align: center; }
        .stat-n { font-size: 24px; font-weight: bold; color: var(--primary); }
        .stat-l { font-size: 12px; color: #888; }

        /* Animation */
        .heart-icon { font-size: 180px; color: var(--primary); opacity: 0.05; position: absolute; }
        .pump { animation: beat 0.15s ease-out; opacity: 0.2 !important; }
        @keyframes beat { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        video { position: absolute; width: 1px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <div class="page">
        <div style="width: 100%; display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
            <div>
                <h2 style="margin: 0; color: var(--primary);">PulseCustom</h2>
                <div style="font-size: 12px; color: #666;">Range: 80 - 160 BPM</div>
            </div>
            <div style="background: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; color: var(--primary);">
                v3.0 Active
            </div>
        </div>

        <div class="monitor-ring">
            <span class="material-symbols-rounded heart-icon" id="heartIcon">favorite</span>
            <div id="bpmDisplay" class="bpm-val">--</div>
            <div class="bpm-lbl">BPM</div>
            <div id="zoneTag" class="zone-badge">แตะเพื่อเริ่ม</div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div id="avgVal" class="stat-n">--</div>
                <div class="stat-l">ค่าเฉลี่ย</div>
            </div>
            <div class="stat-card">
                <div id="statusVal" class="stat-n" style="color: #aaa; font-size: 18px;">Ready</div>
                <div class="stat-l">สถานะ</div>
            </div>
        </div>

        <div class="graph-box"><canvas id="graphCanvas"></canvas></div>

        <button id="actionBtn" class="btn" onclick="toggleMeasure()">เริ่มวัด (START)</button>
    </div>

    <video id="video" playsinline></video>

    <script>
        let video = document.getElementById('video');
        let canvas = document.createElement('canvas');
        let ctx = canvas.getContext('2d', { willReadFrequently: true });
        let graphCanvas = document.getElementById('graphCanvas');
        let graphCtx = graphCanvas.getContext('2d');
        
        let isRunning = false, rafId;
        let signalBuffer = new Array(120).fill(0.5);
        let minVal=0, maxVal=0;
        let lastBeatTime=0;
        let bpmHistory = [];
        let sessionReadings = [];

        function resizeGraph() {
            graphCanvas.width = graphCanvas.offsetWidth;
            graphCanvas.height = graphCanvas.offsetHeight;
        }
        window.onresize = resizeGraph; resizeGraph();

        async function toggleMeasure() {
            let btn = document.getElementById('actionBtn');
            if(!isRunning) {
                try {
                    // เปิดกล้อง
                    let stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: "environment", width: {ideal: 100}, height: {ideal: 100} } 
                    });
                    video.srcObject = stream; await video.play();
                    try { await stream.getVideoTracks()[0].applyConstraints({ advanced: [{ torch: true }] }); } catch(e){}

                    isRunning = true;
                    btn.innerText = "หยุด (STOP)"; btn.classList.add('stop');
                    
                    // Reset ค่า
                    bpmHistory = []; sessionReadings = [];
                    document.getElementById('bpmDisplay').innerText = "--";
                    document.getElementById('avgVal').innerText = "--";
                    updateStatus("Scanning...", "#bdbdbd");
                    
                    loop();
                } catch(e) { alert("กรุณาเปิดสิทธิ์กล้อง"); }
            } else {
                // ปิดกล้อง
                isRunning = false; cancelAnimationFrame(rafId);
                if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
                btn.innerText = "เริ่มวัดใหม่"; btn.classList.remove('stop');
                analyzeResult();
            }
        }

        function loop() {
            if(!isRunning) return;

            // 1. อ่านค่าแสง
            ctx.drawImage(video, 0, 0, 30, 30);
            let frame = ctx.getImageData(15, 15, 1, 1).data; // อ่านจุดเดียว (Fast)
            let avg = frame[0]; 

            // 2. คำนวณกราฟ (Fast Decay สำหรับช่วง 160 BPM)
            if(minVal===0) { minVal=avg; maxVal=avg; }
            minVal = Math.min(minVal, avg); maxVal = Math.max(maxVal, avg);
            minVal += 0.8; maxVal -= 0.8; 

            let range = Math.max(1, maxVal - minVal);
            let inverted = 1.0 - ((avg - minVal) / range);

            signalBuffer.push(inverted); if(signalBuffer.length > 120) signalBuffer.shift();
            drawGraph();

            // 3. จับจังหวะหัวใจ
            // Threshold 0.55 (ไว) + Deadzone 260ms (รับได้ถึง 230 BPM)
            if(inverted > 0.55) {
                let now = Date.now();
                if(now - lastBeatTime > 260) {
                    let bpm = 60 / ((now - lastBeatTime)/1000);
                    lastBeatTime = now;
                    // **ช่วงกว้างพิเศษ: 50 - 200 BPM**
                    if(bpm > 50 && bpm < 200) updateBPM(Math.round(bpm));
                }
            }
            rafId = requestAnimationFrame(loop);
        }

        function updateBPM(bpm) {
            bpmHistory.push(bpm); if(bpmHistory.length > 5) bpmHistory.shift();
            let avg = Math.round(bpmHistory.reduce((a,b)=>a+b,0)/bpmHistory.length);
            
            // UI Update
            document.getElementById('bpmDisplay').innerText = avg;
            
            // Animation
            let icon = document.getElementById('heartIcon');
            icon.classList.remove('pump'); void icon.offsetWidth; icon.classList.add('pump');
            
            // **CUSTOM ZONE LOGIC (80-160)**
            let zone = getCustomZone(avg);
            updateStatus(zone.text, zone.color);
            
            if(bpmHistory.length >= 5) {
                sessionReadings.push(avg);
                // Update Live Average
                let total = Math.round(sessionReadings.reduce((a,b)=>a+b,0)/sessionReadings.length);
                document.getElementById('avgVal').innerText = total;
            }
        }

        function getCustomZone(bpm) {
            // Logic ตามที่คุณขอมา: ปกติคือ 80-160
            if (bpm < 80) return { text: "Low / Rest", color: "#4fc3f7" }; // ฟ้า
            if (bpm <= 120) return { text: "Normal Range", color: "#66bb6a" }; // เขียว (80-120)
            if (bpm <= 160) return { text: "Active / High", color: "#ffa726" }; // ส้ม (121-160)
            return { text: "Peak Warning", color: "#ef5350" }; // แดง (>160)
        }

        function updateStatus(text, color) {
            let el = document.getElementById('zoneTag');
            el.innerText = text; el.style.background = color;
            
            let st = document.getElementById('statusVal');
            st.innerText = text; st.style.color = color;
        }

        function analyzeResult() {
            if(sessionReadings.length > 5) {
                let sum = sessionReadings.reduce((a,b)=>a+b,0);
                let avg = Math.round(sum/sessionReadings.length);
                let z = getCustomZone(avg);
                alert(`สรุปผล: ${avg} BPM\nอยู่ในเกณฑ์: ${z.text}`);
            } else {
                alert("ข้อมูลไม่เพียงพอ");
            }
        }

        function drawGraph() {
            let w = graphCanvas.width;
            let h = graphCanvas.height;
            graphCtx.clearRect(0,0,w,h);
            graphCtx.strokeStyle = "#00838f"; graphCtx.lineWidth = 3;
            graphCtx.beginPath();
            let step = w/120;
            for(let i=0; i<signalBuffer.length; i++){
                let y = h - (signalBuffer[i]*h*0.8) - 10;
                if(i===0) graphCtx.moveTo(0,y); else graphCtx.lineTo(i*step, y);
            }
            graphCtx.stroke();
        }
    </script>
</body>
</html>
