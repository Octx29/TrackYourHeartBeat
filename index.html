<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PulseHeart Precision</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    <style>
        :root {
            --primary: #c2185b; --accent: #ffcdd2; --bg: #ffecf2;
            --text: #4a2c2c; --success: #aed581; --nav-bg: #880e4f;
        }
        body { 
            background-color: var(--bg); color: var(--text);
            font-family: -apple-system, sans-serif; margin: 0; 
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            height: 100vh; overflow: hidden; user-select: none;
            background-image: radial-gradient(circle at 10% 20%, rgba(255, 205, 210, 0.4) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(255, 205, 210, 0.4) 0%, transparent 20%);
        }

        /* Setup Screen */
        #setupScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .input-card {
            background: var(--accent); padding: 30px; border-radius: 30px;
            text-align: center; width: 80%; max-width: 300px;
            box-shadow: 0 10px 30px rgba(194, 24, 91, 0.2);
        }
        input { width: 100%; padding: 15px; font-size: 24px; text-align: center; border-radius: 15px; border: 2px solid var(--primary); margin: 20px 0; }

        /* UI Elements */
        .header { margin-top: 40px; text-align: center; z-index: 2; }
        .title { font-size: 24px; font-weight: 800; color: var(--primary); }
        .monitor-card {
            position: relative; background: var(--accent); width: 280px; height: 280px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            border-radius: 50%; box-shadow: 0 10px 40px rgba(194, 24, 91, 0.15); z-index: 1;
        }
        .bpm-display { font-size: 80px; font-weight: 800; line-height: 1; color: var(--primary); text-shadow: 2px 2px 0px rgba(255,255,255,0.5); }
        .status-tag { margin-top: 15px; padding: 6px 16px; border-radius: 20px; background: #ddd; color: #666; font-weight: bold; font-size: 14px; }
        
        .stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 90%; margin: 20px 0; z-index: 1; }
        .stat-box { background: var(--accent); padding: 15px; border-radius: 20px; text-align: center; box-shadow: 0 5px 15px rgba(194, 24, 91, 0.1); }
        .stat-val { font-size: 22px; font-weight: 800; color: var(--primary); }

        .graph-area { width: 90%; height: 60px; background: var(--accent); border-radius: 15px; overflow: hidden; position: relative; z-index: 1; margin-bottom: 20px; }
        canvas { width: 100%; height: 100%; display: block; }

        .btn { width: 100%; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 30px; background: var(--primary); color: white; box-shadow: 0 8px 20px rgba(194, 24, 91, 0.4); margin-bottom: 20px; }
        .btn.stop { background: #d32f2f; }
        .bottom-section { width: 80%; z-index: 2; display: flex; flex-direction: column; align-items: center; }

        /* Nav Bar */
        .nav-bar { width: 100vw; height: 70px; background: var(--nav-bg); border-radius: 30px 30px 0 0; display: flex; justify-content: space-around; align-items: center; color: rgba(255,255,255,0.6); }
        .nav-item.active { color: white; }
        .material-symbols-rounded { font-size: 32px; }

        /* Animation & BG */
        .bg-heart { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 300px; color: var(--primary); opacity: 0.05; z-index: 0; }
        @keyframes beat { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .beating { animation: beat 0.3s infinite ease-in-out; }
        video { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <div id="setupScreen">
        <div class="input-card">
            <span class="material-symbols-rounded" style="font-size: 60px; color: var(--primary);">favorite</span>
            <h2 style="color: var(--primary);">ระบุอายุ</h2>
            <input type="number" id="ageInput" placeholder="เช่น 25">
            <button class="btn" onclick="saveAge()">เริ่มเลย</button>
        </div>
    </div>

    <span class="material-symbols-rounded bg-heart">favorite</span>
    <div class="header">
        <div class="title">PulseHeart</div>
        <div id="userInfoDisplay" style="font-size: 12px; opacity: 0.7;">Stable Edition</div>
    </div>

    <div class="monitor-card">
        <span class="material-symbols-rounded" style="font-size: 150px; color: var(--primary); opacity: 0.1; position: absolute;" id="heartIcon">favorite</span>
        <div id="bpmVal" class="bpm-display">--</div>
        <div style="font-size: 14px; font-weight: bold;">BPM</div>
        <div id="zoneTag" class="status-tag">แตะเพื่อเริ่ม</div>
    </div>

    <div class="stats-container">
        <div class="stat-box">
            <div style="font-size: 12px; opacity: 0.8;">ค่าเฉลี่ย</div>
            <div id="avgVal" class="stat-val">--</div>
        </div>
        <div class="stat-box">
            <div style="font-size: 12px; opacity: 0.8;">ความนิ่ง</div>
            <div id="stabilityVal" class="stat-val">0%</div>
        </div>
    </div>

    <div class="graph-area"><canvas id="graphCanvas"></canvas></div>

    <div class="bottom-section">
        <button id="actionBtn" class="btn" onclick="toggleMeasure()">เริ่มวัด (START)</button>
    </div>

    <div class="nav-bar">
        <div class="nav-item"><span class="material-symbols-rounded">vital_signs</span></div>
        <div class="nav-item active"><span class="material-symbols-rounded">home</span></div>
        <div class="nav-item"><span class="material-symbols-rounded">person</span></div>
    </div>

    <video id="video" playsinline></video>

    <script>
        let userAge = 25, maxHeartRate = 195;
        let video = document.getElementById('video');
        let canvas = document.createElement('canvas');
        let ctx = canvas.getContext('2d', { willReadFrequently: true });
        let graphCtx = document.getElementById('graphCanvas').getContext('2d');
        
        let isRunning = false, animationFrame;
        let signalBuffer = new Array(100).fill(0.5);
        let bpmHistory = [], sessionReadings = [];
        let lastBeatTime = 0;
        let minVal = 0, maxVal = 0;
        let stabilityCounter = 0;

        function saveAge() {
            let val = document.getElementById('ageInput').value;
            if(val > 5 && val < 100) {
                userAge = parseInt(val);
                maxHeartRate = 220 - userAge;
                document.getElementById('setupScreen').style.display = 'none';
            } else alert("ใส่อายุให้ถูกต้อง");
        }

        function resize() {
            let gc = document.getElementById('graphCanvas');
            gc.width = gc.offsetWidth; gc.height = gc.offsetHeight;
        }
        window.onresize = resize; resize();

        async function toggleMeasure() {
            let btn = document.getElementById('actionBtn');
            if (!isRunning) {
                try {
                    let stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    video.srcObject = stream; await video.play();
                    try { stream.getVideoTracks()[0].applyConstraints({ advanced: [{ torch: true }] }); } catch(e) {}

                    isRunning = true;
                    btn.innerText = "หยุด (STOP)"; btn.classList.add('stop');
                    bpmHistory = []; sessionReadings = [];
                    document.getElementById('bpmVal').innerText = "--";
                    updateTag("กำลังวัด...", "#ddd", "#666");
                    loop();
                } catch(e) { alert("กรุณาเปิดสิทธิ์กล้อง"); }
            } else {
                stopCamera();
                analyze();
            }
        }

        function stopCamera() {
            isRunning = false; cancelAnimationFrame(animationFrame);
            if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
            let btn = document.getElementById('actionBtn');
            btn.innerText = "เริ่มวัดใหม่"; btn.classList.remove('stop');
            document.getElementById('heartIcon').classList.remove('beating');
        }

        function loop() {
            if(!isRunning) return;
            // 1. Image Processing
            ctx.drawImage(video, 0, 0, 40, 40);
            let data = ctx.getImageData(15, 15, 10, 10).data;
            let total = 0;
            for(let i=0; i<data.length; i+=4) total += data[i];
            let avg = total / (data.length/4);

            // 2. Adaptive Gain
            if(minVal === 0) { minVal = avg; maxVal = avg; }
            minVal = Math.min(minVal, avg); maxVal = Math.max(maxVal, avg);
            // *Fix 1: Slow Decay (ลดอาการกราฟสวิง)*
            minVal += 0.2; maxVal -= 0.2; 

            let range = Math.max(1, maxVal - minVal);
            let inverted = 1.0 - ((avg - minVal) / range);

            signalBuffer.push(inverted); if(signalBuffer.length > 100) signalBuffer.shift();
            drawGraph();

            // 3. Peak Detection & Debounce
            // *Fix 2: Threshold สูงขึ้น (0.7) ต้องเป็นยอดกราฟจริงๆ ถึงนับ*
            if(inverted > 0.70) {
                let now = Date.now();
                // *Fix 3: Time Filter (350ms) ถ้าระยะห่างน้อยกว่านี้ (เช่น 170 BPM+) ถือว่าเป็น Noise*
                // คนทั่วไปนั่งพัก หัวใจไม่ควรเกิน 170
                if(now - lastBeatTime > 350) { 
                    let bpm = 60 / ((now - lastBeatTime) / 1000);
                    lastBeatTime = now;
                    // *Fix 4: Range Valid (50-160)*
                    if(bpm > 50 && bpm < 160) {
                        updateUI(Math.round(bpm));
                    }
                }
            }
            animationFrame = requestAnimationFrame(loop);
        }

        function updateUI(bpm) {
            // *Fix 5: Smoothing Average (ใช้ 10 ค่าล่าสุดมาเฉลี่ย)*
            bpmHistory.push(bpm);
            if(bpmHistory.length > 10) bpmHistory.shift();
            
            // ตัดค่าที่โดดเกินไปออก (Simple Outlier Filter)
            let sorted = [...bpmHistory].sort((a,b)=>a-b);
            let valid = sorted;
            if(sorted.length > 4) valid = sorted.slice(1, -1); // ตัดค่ามากสุดและน้อยสุดออก
            
            let avg = Math.round(valid.reduce((a,b)=>a+b,0)/valid.length);

            // บันทึกผลเมื่อค่านิ่ง
            if(bpmHistory.length >= 5) {
                sessionReadings.push(avg);
                stabilityCounter = Math.min(100, stabilityCounter + 2);
            }

            document.getElementById('bpmVal').innerText = avg;
            updateTag("กำลังวัด...", "#aed581", "#fff");
            document.getElementById('heartIcon').classList.add('beating');
            setTimeout(()=>document.getElementById('heartIcon').classList.remove('beating'), 150);

            if(sessionReadings.length > 0) {
                let finalAvg = Math.round(sessionReadings.reduce((a,b)=>a+b,0)/sessionReadings.length);
                document.getElementById('avgVal').innerText = finalAvg;
            }
            document.getElementById('stabilityVal').innerText = stabilityCounter + "%";
        }

        function updateTag(text, bg, col) {
            let t = document.getElementById('zoneTag');
            t.innerText = text; t.style.background = bg; t.style.color = col;
        }

        function analyze() {
            if(sessionReadings.length > 5) {
                let sum = sessionReadings.reduce((a,b)=>a+b,0);
                let avg = Math.round(sum/sessionReadings.length);
                alert(`สรุปผล: ${avg} BPM`);
            } else {
                alert("เวลาน้อยเกินไป วัดไม่สำเร็จ");
            }
        }

        function drawGraph() {
            let w = graphCtx.canvas.width, h = graphCtx.canvas.height;
            graphCtx.clearRect(0,0,w,h);
            graphCtx.strokeStyle = "#c2185b"; graphCtx.lineWidth = 2;
            graphCtx.beginPath();
            let step = w/100;
            for(let i=0; i<signalBuffer.length; i++) {
                let y = h - (signalBuffer[i] * h * 0.8) - 5;
                if(i===0) graphCtx.moveTo(0,y); else graphCtx.lineTo(i*step, y);
            }
            graphCtx.stroke();
        }
    </script>
</body>
</html>
