<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffebee">
    <title>PulseHeart Pro UI</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />

    <style>
        :root {
            --primary: #d81b60;       /* ‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏Ç‡πâ‡∏° (Vivid Pink) */
            --primary-light: #ff4081; /* ‡∏ä‡∏°‡∏û‡∏π‡∏™‡∏ß‡πà‡∏≤‡∏á (Accent) */
            --bg-color: #fce4ec;      /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏Å */
            --glass: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.5);
            --shadow: 0 8px 32px 0 rgba(216, 27, 96, 0.15);
            --text-main: #2d1b22;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            background: var(--bg-color);
            background-image: 
                radial-gradient(at 0% 0%, hsla(340,100%,85%,1) 0, transparent 50%), 
                radial-gradient(at 100% 100%, hsla(330,100%,88%,1) 0, transparent 50%);
            color: var(--text-main);
            font-family: 'Fredoka', sans-serif;
            margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            user-select: none;
        }

        /* --- SETUP MODAL --- */
        #setupScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(252, 228, 236, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .modal-card {
            background: white; padding: 40px 30px; border-radius: 40px;
            text-align: center; width: 85%; max-width: 320px;
            box-shadow: 0 20px 60px rgba(216, 27, 96, 0.2);
            border: 1px solid white;
        }
        .input-group input {
            width: 100%; padding: 15px; font-size: 28px; text-align: center;
            border: 2px solid #f06292; border-radius: 20px;
            background: #fff0f6; color: var(--primary); font-family: 'Fredoka', sans-serif;
            outline: none; margin: 20px 0; font-weight: bold;
        }

        /* --- HEADER --- */
        .header { 
            padding-top: max(20px, env(safe-area-inset-top)); 
            width: 100%; text-align: center; z-index: 2; 
        }
        .app-title {
            font-size: 24px; font-weight: 700; color: var(--primary);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .user-badge {
            display: inline-block; background: rgba(255,255,255,0.6);
            padding: 5px 15px; border-radius: 20px; font-size: 12px;
            color: #880e4f; margin-top: 5px; font-weight: 600;
            border: 1px solid white;
        }

        /* --- MAIN MONITOR --- */
        .monitor-container {
            position: relative; flex-grow: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center; width: 100%;
        }

        /* Glass Circle */
        .pulse-ring {
            position: relative; width: 260px; height: 260px;
            background: var(--glass);
            border-radius: 50%;
            border: 2px solid var(--glass-border);
            box-shadow: var(--shadow);
            backdrop-filter: blur(8px);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: transform 0.2s;
        }

        .heart-bg {
            position: absolute; font-size: 180px; color: var(--primary);
            opacity: 0.05; z-index: -1; transition: transform 0.1s;
        }

        .bpm-value {
            font-size: 90px; font-weight: 600; line-height: 1;
            color: var(--primary); letter-spacing: -2px;
            background: -webkit-linear-gradient(45deg, #d81b60, #ff4081);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .bpm-label { font-size: 16px; color: #880e4f; opacity: 0.7; font-weight: 600; margin-top: -5px; }

        .zone-pill {
            margin-top: 15px; padding: 6px 18px; border-radius: 30px;
            font-size: 13px; font-weight: 700; color: white;
            background: #bdbdbd; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* --- STATS GRID --- */
        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            width: 85%; margin-bottom: 20px;
        }
        .stat-card {
            background: white; padding: 15px; border-radius: 25px;
            text-align: center; box-shadow: 0 5px 15px rgba(216, 27, 96, 0.05);
            border: 1px solid rgba(255,255,255,0.8);
        }
        .stat-num { font-size: 20px; font-weight: 700; color: var(--primary); }
        .stat-name { font-size: 11px; color: #9e9e9e; font-weight: 600; margin-top: 2px; }

        /* --- GRAPH --- */
        .graph-wrapper {
            width: 85%; height: 80px; 
            background: white; border-radius: 20px;
            padding: 10px; position: relative; overflow: hidden;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.02);
            border: 1px solid rgba(255,255,255,0.8);
            margin-bottom: 20px;
        }
        canvas { width: 100%; height: 100%; display: block; }

        /* --- CONTROLS --- */
        .control-area {
            width: 100%; background: white;
            padding: 20px 30px 40px;
            border-radius: 40px 40px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.05);
            z-index: 10;
        }
        
        .main-btn {
            width: 100%; padding: 18px; border: none; border-radius: 25px;
            font-size: 18px; font-weight: 700; color: white;
            font-family: 'Fredoka', sans-serif; cursor: pointer;
            background: linear-gradient(135deg, #d81b60, #ff4081);
            box-shadow: 0 10px 25px rgba(216, 27, 96, 0.3);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .main-btn:active { transform: scale(0.97); box-shadow: 0 5px 15px rgba(216, 27, 96, 0.2); }
        .main-btn.stop { background: linear-gradient(135deg, #ef5350, #e53935); box-shadow: 0 10px 25px rgba(229, 57, 53, 0.3); }

        /* Helpers */
        video { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
        .beating { animation: heartbeat 0.4s ease-in-out infinite; }
        
        @keyframes heartbeat {
            0% { transform: scale(1); opacity: 0.1; }
            20% { transform: scale(1.15); opacity: 0.2; }
            40% { transform: scale(1); opacity: 0.1; }
        }
    </style>
</head>
<body>

    <div id="setupScreen">
        <div class="modal-card">
            <span class="material-symbols-rounded" style="font-size: 64px; color: var(--primary);">favorite</span>
            <h2 style="color: var(--primary); margin: 10px 0;">PulseHeart</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">‡πÉ‡∏™‡πà‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì<br>‡πÇ‡∏ã‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
            
            <div class="input-group">
                <input type="number" id="ageInput" placeholder="25" inputmode="numeric">
            </div>
            
            <button class="main-btn" onclick="saveAge()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
        </div>
    </div>

    <div class="header">
        <div class="app-title">
            <span class="material-symbols-rounded">ecg_heart</span> PulseHeart
        </div>
        <div class="user-badge" id="userInfoDisplay">Guest Mode</div>
    </div>

    <div class="monitor-container">
        <div class="pulse-ring">
            <span class="material-symbols-rounded heart-bg" id="heartIcon">favorite</span>
            <div id="bpmVal" class="bpm-value">--</div>
            <div class="bpm-label">BPM</div>
            <div id="zoneTag" class="zone-pill">‡πÅ‡∏ï‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div id="avgVal" class="stat-num">--</div>
            <div class="stat-name">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (AVG)</div>
        </div>
        <div class="stat-card">
            <div id="stabilityVal" class="stat-num">0%</div>
            <div class="stat-name">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£</div>
        </div>
    </div>

    <div class="graph-wrapper">
        <canvas id="graphCanvas"></canvas>
    </div>

    <div class="control-area">
        <button id="actionBtn" class="main-btn" onclick="toggleMeasure()">
            <span class="material-symbols-rounded" style="vertical-align: middle; margin-right: 5px;">play_circle</span>
            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏î‡∏ä‡∏µ‡∏û‡∏à‡∏£
        </button>
    </div>

    <video id="video" playsinline></video>

    <script>
        // --- Configuration ---
        let userAge = 25;
        let maxHeartRate = 195;
        
        // --- Elements ---
        let video = document.getElementById('video');
        let canvas = document.createElement('canvas');
        let ctx = canvas.getContext('2d', { willReadFrequently: true });
        let graphCanvas = document.getElementById('graphCanvas');
        let graphCtx = graphCanvas.getContext('2d');
        
        // --- Variables ---
        let isRunning = false;
        let animationFrame;
        let signalBuffer = new Array(100).fill(0.5);
        let bpmHistory = [];
        let sessionReadings = [];
        let lastBeatTime = 0;
        let minVal = 0, maxVal = 0;
        let stabilityCounter = 0;

        // --- Step 1: Initialize ---
        function saveAge() {
            let val = document.getElementById('ageInput').value;
            if(val > 5 && val < 100) {
                userAge = parseInt(val);
                maxHeartRate = 220 - userAge;
                
                let modal = document.getElementById('setupScreen');
                modal.style.opacity = '0';
                setTimeout(() => modal.style.display = 'none', 500);
                
                document.getElementById('userInfoDisplay').innerText = `Age: ${userAge} | Max HR: ${maxHeartRate}`;
            } else {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (5-99 ‡∏õ‡∏µ)");
            }
        }

        // Resize Canvas dynamically
        function resize() {
            graphCanvas.width = graphCanvas.offsetWidth * 2; // Retina sharpness
            graphCanvas.height = graphCanvas.offsetHeight * 2;
        }
        window.onresize = resize;
        resize();

        // --- Step 2: Camera & Logic ---
        async function toggleMeasure() {
            let btn = document.getElementById('actionBtn');
            
            if (!isRunning) {
                // START
                try {
                    let stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: "environment", width: {ideal: 100}, height: {ideal: 100} } 
                    });
                    video.srcObject = stream;
                    await video.play();

                    // Try Flash
                    try { 
                        let track = stream.getVideoTracks()[0];
                        await track.applyConstraints({ advanced: [{ torch: true }] }); 
                    } catch(e) {}

                    isRunning = true;
                    btn.innerHTML = `<span class="material-symbols-rounded" style="vertical-align: bottom;">stop_circle</span> ‡∏´‡∏¢‡∏∏‡∏î (STOP)`;
                    btn.classList.add('stop');
                    
                    // Reset Logic
                    bpmHistory = []; 
                    sessionReadings = [];
                    document.getElementById('bpmVal').innerText = "--";
                    document.getElementById('avgVal').innerText = "--";
                    updateTag("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏á...", "#bdbdbd");
                    stabilityCounter = 0;
                    
                    loop();

                } catch (err) {
                    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: " + err.message);
                }
            } else {
                // STOP
                stopCamera();
                analyzeResult();
            }
        }

        function stopCamera() {
            isRunning = false;
            cancelAnimationFrame(animationFrame);
            if(video.srcObject) {
                video.srcObject.getTracks().forEach(t => t.stop());
                video.srcObject = null;
            }
            let btn = document.getElementById('actionBtn');
            btn.innerHTML = `<span class="material-symbols-rounded" style="vertical-align: bottom;">replay</span> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà`;
            btn.classList.remove('stop');
            document.getElementById('heartIcon').classList.remove('beating');
        }

        // --- Step 3: Zones ---
        function getZone(bpm) {
            let p = (bpm / maxHeartRate) * 100;
            if (p < 50) return { t: "Warm Up", c: "#29b6f6" };
            if (p < 60) return { t: "Fat Burn", c: "#66bb6a" };
            if (p < 70) return { t: "Cardio", c: "#ffa726" };
            if (p < 80) return { t: "Hard", c: "#ef5350" };
            return { t: "Peak", c: "#c62828" };
        }

        function updateTag(text, color) {
            let el = document.getElementById('zoneTag');
            el.innerText = text;
            el.style.background = color;
        }

        // --- Step 4: The Loop (Medical Algorithm) ---
        function loop() {
            if(!isRunning) return;

            // 1. Read Camera
            ctx.drawImage(video, 0, 0, 30, 30);
            let frame = ctx.getImageData(10, 10, 10, 10).data; // Center 10x10
            let total = 0;
            for(let i=0; i<frame.length; i+=4) total += frame[i]; // Red channel
            let avg = total / (frame.length/4);

            // 2. Signal Processing (Auto-Gain)
            if(minVal === 0) { minVal = avg; maxVal = avg; }
            minVal = Math.min(minVal, avg); 
            maxVal = Math.max(maxVal, avg);
            
            // *Decay* (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏´‡∏≤‡∏Å‡∏ô‡∏¥‡πâ‡∏ß‡∏Ç‡∏¢‡∏±‡∏ö)
            minVal += 0.3; 
            maxVal -= 0.3;

            let range = Math.max(1, maxVal - minVal);
            let rawVal = (avg - minVal) / range;
            let inverted = 1.0 - rawVal; // Pulse = Darker

            // Update Graph Buffer
            signalBuffer.push(inverted);
            if(signalBuffer.length > 100) signalBuffer.shift();
            drawGraph();

            // 3. Peak Detection (Logic ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏î)
            if(inverted > 0.65) { // Threshold 65%
                let now = Date.now();
                // *Dead Zone 350ms* = Max 170 BPM (‡∏Å‡∏±‡∏ô Double count)
                if(now - lastBeatTime > 350) { 
                    let interval = (now - lastBeatTime) / 1000;
                    lastBeatTime = now;
                    let bpm = 60 / interval;

                    // Filter Range (45 - 180 BPM)
                    if(bpm > 45 && bpm < 180) {
                        updateBPM(Math.round(bpm));
                    }
                }
            }

            animationFrame = requestAnimationFrame(loop);
        }

        function updateBPM(bpm) {
            // Smooth Average (Last 10 beats)
            bpmHistory.push(bpm);
            if(bpmHistory.length > 10) bpmHistory.shift();

            // Trim outliers (‡∏ï‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î/‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏≠‡∏≠‡∏Å 1 ‡∏Ñ‡πà‡∏≤)
            let sorted = [...bpmHistory].sort((a,b)=>a-b);
            let valid = sorted.length > 4 ? sorted.slice(1, -1) : sorted;
            let avg = Math.round(valid.reduce((a,b)=>a+b,0) / valid.length);

            // Update UI
            document.getElementById('bpmVal').innerText = avg;
            
            // Zone
            let zone = getZone(avg);
            updateTag(zone.t, zone.c);
            
            // Animation
            let heart = document.getElementById('heartIcon');
            heart.classList.remove('beating');
            void heart.offsetWidth; // Trigger reflow
            heart.classList.add('beating');

            // Session Stats
            if(bpmHistory.length >= 5) {
                sessionReadings.push(avg);
                stabilityCounter = Math.min(100, stabilityCounter + 2);
            }
            
            if(sessionReadings.length > 0) {
                let totalAvg = Math.round(sessionReadings.reduce((a,b)=>a+b,0)/sessionReadings.length);
                document.getElementById('avgVal').innerText = totalAvg;
            }
            document.getElementById('stabilityVal').innerText = stabilityCounter + "%";
        }

        function analyzeResult() {
            if(sessionReadings.length > 5) {
                let sum = sessionReadings.reduce((a,b)=>a+b,0);
                let avg = Math.round(sum/sessionReadings.length);
                alert(`üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î\n\n‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${avg} BPM\n‡πÇ‡∏ã‡∏ô: ${getZone(avg).t}`);
            } else {
                alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ô‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô");
            }
        }

        function drawGraph() {
            let w = graphCanvas.width;
            let h = graphCanvas.height;
            graphCtx.clearRect(0, 0, w, h);
            
            // Create Gradient
            let grad = graphCtx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, "rgba(216, 27, 96, 0.2)");
            grad.addColorStop(1, "rgba(255, 255, 255, 0)");

            graphCtx.beginPath();
            graphCtx.moveTo(0, h);
            
            let step = w / 100;
            for(let i=0; i<signalBuffer.length; i++) {
                let y = h - (signalBuffer[i] * h * 0.8) - (h*0.1);
                graphCtx.lineTo(i * step, y);
            }
            
            // Fill area
            graphCtx.lineTo(w, h);
            graphCtx.fillStyle = grad;
            graphCtx.fill();

            // Draw Line
            graphCtx.beginPath();
            graphCtx.strokeStyle = "#d81b60";
            graphCtx.lineWidth = 4;
            graphCtx.lineJoin = "round";
            for(let i=0; i<signalBuffer.length; i++) {
                let y = h - (signalBuffer[i] * h * 0.8) - (h*0.1);
                if(i===0) graphCtx.moveTo(0, y);
                else graphCtx.lineTo(i * step, y);
            }
            graphCtx.stroke();
        }
    </script>
</body>
</html>
