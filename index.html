<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PulseHeart Pink</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    <style>
        :root {
            /* ‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ */
            --primary: #c2185b;   /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏° (‡∏´‡∏±‡∏ß‡πÉ‡∏à, ‡∏õ‡∏∏‡πà‡∏°, ‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü) */
            --accent: #ffcdd2;    /* ‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô (‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î) */
            --bg: #ffecf2;        /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å (‡∏ä‡∏°‡∏û‡∏π‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•) */
            --text: #4a2c2c;      /* ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ (‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÄ‡∏Ç‡πâ‡∏°) */
            --success: #aed581;   /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô (‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞) */
            --nav-bg: #880e4f;    /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
        }
        body { 
            background-color: var(--bg); 
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            height: 100vh; overflow: hidden; user-select: none;
            background-image: radial-gradient(circle at 10% 20%, rgba(255, 205, 210, 0.4) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(255, 205, 210, 0.4) 0%, transparent 20%);
        }

        /* --- SETUP SCREEN --- */
        #setupScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .input-card {
            background: var(--accent); padding: 30px; border-radius: 30px;
            text-align: center; width: 80%; max-width: 300px;
            box-shadow: 0 10px 30px rgba(194, 24, 91, 0.2);
        }
        input[type="number"] {
            width: 100%; padding: 15px; font-size: 24px; text-align: center;
            background: #fff; border: 2px solid var(--primary); border-radius: 15px;
            color: var(--text); outline: none; margin: 20px 0;
        }
        
        /* --- MAIN UI --- */
        .header { 
            margin-top: 50px; 
            text-align: center; 
            z-index: 2;
        }
        .title { 
            font-size: 24px; font-weight: 800; color: var(--primary); 
        }
        .user-info { font-size: 14px; color: var(--text); opacity: 0.7; margin-top: 5px; }

        /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏î‡∏ß‡∏á‡πÉ‡∏´‡∏ç‡πà */
        .bg-heart {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 300px;
            color: var(--primary);
            opacity: 0.05;
            z-index: 0;
        }

        .monitor-card {
            position: relative;
            background: var(--accent);
            width: 280px; height: 280px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            border-radius: 50%;
            box-shadow: 0 10px 40px rgba(194, 24, 91, 0.15);
            z-index: 1;
        }
        
        .heart-icon-bg {
            position: absolute;
            font-size: 180px;
            color: var(--primary);
            opacity: 0.1;
        }

        .bpm-display { 
            font-size: 80px; font-weight: 800; line-height: 1; color: var(--primary);
            text-shadow: 2px 2px 0px rgba(255,255,255,0.5);
        }
        .bpm-label { font-size: 16px; color: var(--text); font-weight: bold; }

        .status-tag { 
            margin-top: 15px;
            padding: 6px 16px; 
            border-radius: 20px; 
            background: var(--success); 
            color: #fff; font-weight: bold; font-size: 14px;
            box-shadow: 0 4px 10px rgba(174, 213, 129, 0.3);
            transition: all 0.3s;
        }
        
        /* Stats Grid */
        .stats-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 90%; margin: 20px 0; z-index: 1;
        }
        .stat-box {
            background: var(--accent); padding: 15px; border-radius: 20px; text-align: center;
            box-shadow: 0 5px 15px rgba(194, 24, 91, 0.1);
            display: flex; flex-direction: column; justify-content: center;
        }
        .stat-val { font-size: 22px; font-weight: 800; color: var(--primary); }
        .stat-lbl { font-size: 12px; color: var(--text); opacity: 0.8; margin-top: 2px; }

        /* Graph */
        .graph-area {
            width: 90%; height: 60px; background: var(--accent); border-radius: 15px;
            overflow: hidden; position: relative; z-index: 1; margin-bottom: 20px;
        }
        canvas { width: 100%; height: 100%; display: block; }

        /* Controls & Nav */
        .bottom-section {
            width: 100%; display: flex; flex-direction: column; align-items: center; z-index: 2;
        }
        .btn-area { width: 80%; margin-bottom: 20px; }
        .btn {
            width: 100%; padding: 18px; font-size: 18px; font-weight: bold;
            border: none; border-radius: 30px; cursor: pointer;
            background: var(--primary); color: white;
            box-shadow: 0 8px 20px rgba(194, 24, 91, 0.4);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn.stop { background: #d32f2f; }

        /* Bottom Navigation Bar */
        .nav-bar {
            width: 100%; height: 70px;
            background: var(--nav-bg);
            border-top-left-radius: 30px; border-top-right-radius: 30px;
            display: flex; justify-content: space-around; align-items: center;
            color: rgba(255,255,255,0.6);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; font-size: 28px;
        }
        .nav-item.active {
            color: white;
        }
        .material-symbols-rounded { font-size: 32px; }

        video { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
        
        /* Animations */
        @keyframes beat {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .beating { animation: beat 0.5s infinite ease-in-out; }

    </style>
</head>
<body>

    <div id="setupScreen">
        <div class="input-card">
            <span class="material-symbols-rounded" style="font-size: 60px; color: var(--primary);">favorite</span>
            <h2 style="margin: 10px 0; color: var(--primary);">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!</h2>
            <p style="color: var(--text); opacity: 0.8;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</p>
            <input type="number" id="ageInput" placeholder="‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)" min="5" max="100">
            <button class="btn" onclick="saveAge()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
        </div>
    </div>

    <span class="material-symbols-rounded bg-heart">favorite</span>

    <div class="header">
        <div class="title">PulseHeart</div>
        <div class="user-info" id="userInfoDisplay">‡∏≠‡∏≤‡∏¢‡∏∏: -- ‡∏õ‡∏µ</div>
    </div>

    <div class="monitor-card">
        <span class="material-symbols-rounded heart-icon-bg" id="heartIcon">favorite</span>
        <div id="bpmVal" class="bpm-display">--</div>
        <div class="bpm-label">bpm</div>
        <div id="zoneTag" class="status-tag" style="background: #ddd; color: #666;">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
    </div>

    <div class="stats-container">
        <div class="stat-box">
            <div class="stat-lbl">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (AVG)</div>
            <div id="avgVal" class="stat-val">--</div>
            <div class="stat-lbl" style="font-size: 10px;">bpm</div>
        </div>
        <div class="stat-box">
            <div class="stat-lbl">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£</div>
            <div id="stabilityVal" class="stat-val">0%</div>
            <div class="stat-tag" style="font-size: 10px; color: var(--success);">‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</div>
        </div>
    </div>

    <div class="graph-area">
        <canvas id="graphCanvas"></canvas>
    </div>

    <div class="bottom-section">
        <div class="btn-area">
            <button id="actionBtn" class="btn" onclick="toggleMeasure()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏î (START)</button>
        </div>
        
        <div class="nav-bar">
            <div class="nav-item">
                <span class="material-symbols-rounded">vital_signs</span>
            </div>
            <div class="nav-item active">
                <span class="material-symbols-rounded">home</span>
            </div>
            <div class="nav-item">
                <span class="material-symbols-rounded">person</span>
            </div>
        </div>
    </div>

    <video id="video" playsinline></video>

    <script>
        let userAge = 25;
        let maxHeartRate = 195;
        
        let video = document.getElementById('video');
        let canvas = document.createElement('canvas');
        let ctx = canvas.getContext('2d', { willReadFrequently: true });
        let graphCanvas = document.getElementById('graphCanvas');
        let graphCtx = graphCanvas.getContext('2d');
        
        let isRunning = false;
        let animationFrame;
        let signalBuffer = new Array(100).fill(0.5);
        let bpmHistory = [];
        let sessionReadings = [];
        let lastBeatTime = 0;
        let minVal = 0, maxVal = 0;
        let stabilityCounter = 0;

        function saveAge() {
            let input = document.getElementById('ageInput').value;
            if (input && input > 5 && input < 100) {
                userAge = parseInt(input);
                maxHeartRate = 220 - userAge;
                document.getElementById('setupScreen').style.display = 'none';
                document.getElementById('userInfoDisplay').innerText = `‡∏≠‡∏≤‡∏¢‡∏∏: ${userAge} ‡∏õ‡∏µ | Max HR: ${maxHeartRate}`;
            } else {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            }
        }

        function resize() {
            graphCanvas.width = graphCanvas.offsetWidth;
            graphCanvas.height = graphCanvas.offsetHeight;
        }
        window.onresize = resize;
        resize();

        async function toggleMeasure() {
            let btn = document.getElementById('actionBtn');
            if (!isRunning) {
                try {
                    let stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: "environment", width: { ideal: 150 }, height: { ideal: 150 } }
                    });
                    video.srcObject = stream;
                    await video.play();
                    try { stream.getVideoTracks()[0].applyConstraints({ advanced: [{ torch: true }] }); } catch(e) {}

                    isRunning = true;
                    btn.innerText = "‡∏´‡∏¢‡∏∏‡∏î (STOP)";
                    btn.classList.add('stop');
                    
                    bpmHistory = []; sessionReadings = [];
                    document.getElementById('bpmVal').innerText = "--";
                    document.getElementById('avgVal').innerText = "--";
                    updateZoneTag("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏î...", "#ddd", "#666");
                    stabilityCounter = 0;
                    
                    loop();
                } catch (err) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏•‡πâ‡∏≠‡∏á"); }
            } else {
                stopCamera();
                analyzeResult();
            }
        }

        function stopCamera() {
            isRunning = false;
            cancelAnimationFrame(animationFrame);
            if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById('actionBtn').innerText = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà (START)";
            document.getElementById('actionBtn').classList.remove('stop');
            document.getElementById('heartIcon').classList.remove('beating');
        }

        function getZone(bpm) {
            let percent = (bpm / maxHeartRate) * 100;
            if (percent < 50) return { name: "Warm Up", color: "#aaddff", tagColor: "#81d4fa" };
            if (percent < 60) return { name: "Fat Burn", color: "#aed581", tagColor: "#aed581" };
            if (percent < 70) return { name: "Cardio", color: "#ffd54f", tagColor: "#ffd54f" };
            if (percent < 80) return { name: "Hard", color: "#ffb74d", tagColor: "#ffb74d" };
            return { name: "Peak", color: "#e57373", tagColor: "#ef5350" };
        }

        function updateZoneTag(text, bgColor, textColor = "#fff") {
            let tag = document.getElementById('zoneTag');
            tag.innerText = text;
            tag.style.background = bgColor;
            tag.style.color = textColor;
        }

        function analyzeResult() {
            let finalAvg = 0;
            if (sessionReadings.length > 5) {
                sessionReadings.sort((a,b) => a-b);
                let validData = sessionReadings.slice(2, -2);
                if (validData.length > 0) {
                    finalAvg = Math.round(validData.reduce((a,b) => a+b, 0) / validData.length);
                }
            }
            if (finalAvg > 0) {
                let zone = getZone(finalAvg);
                alert(`üíó ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î (‡∏≠‡∏≤‡∏¢‡∏∏ ${userAge} ‡∏õ‡∏µ)\n\n‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${finalAvg} bpm\n‡πÇ‡∏ã‡∏ô: ${zone.name}`);
                document.getElementById('avgVal').innerText = finalAvg;
                updateZoneTag(zone.name, zone.tagColor);
            } else {
                alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠");
                updateZoneTag("‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå", "#ef5350");
            }
        }

        function loop() {
            if (!isRunning) return;
            ctx.drawImage(video, 0, 0, 40, 40);
            let data = ctx.getImageData(15, 15, 10, 10).data;
            let totalRed = 0;
            for (let i = 0; i < data.length; i += 4) totalRed += data[i];
            let avgRed = totalRed / (data.length / 4);

            if (minVal === 0) { minVal = avgRed; maxVal = avgRed; }
            minVal = Math.min(minVal, avgRed); maxVal = Math.max(maxVal, avgRed);
            minVal += 0.5; maxVal -= 0.5;
            let inverted = 1.0 - ((avgRed - minVal) / Math.max(1, maxVal - minVal));

            signalBuffer.push(inverted);
            if (signalBuffer.length > 100) signalBuffer.shift();
            drawGraph();

            if (inverted > 0.60) {
                let now = Date.now();
                if (now - lastBeatTime > 300) {
                    let bpm = 60 / ((now - lastBeatTime) / 1000);
                    lastBeatTime = now;
                    if (bpm > 45 && bpm < 200) updateUI(Math.round(bpm));
                }
            }
            animationFrame = requestAnimationFrame(loop);
        }

        function updateUI(bpm) {
            bpmHistory.push(bpm);
            if (bpmHistory.length > 5) bpmHistory.shift();
            let smoothBPM = Math.round(bpmHistory.reduce((a,b) => a+b, 0) / bpmHistory.length);
            
            if (bpmHistory.length >= 5) {
                sessionReadings.push(smoothBPM);
                stabilityCounter = Math.min(100, stabilityCounter + 5);
            } else {
                stabilityCounter = Math.max(0, stabilityCounter - 2);
            }

            let zone = getZone(smoothBPM);
            document.getElementById('bpmVal').innerText = smoothBPM;
            updateZoneTag(zone.name, zone.tagColor);
            
            document.getElementById('heartIcon').classList.add('beating');
            setTimeout(() => document.getElementById('heartIcon').classList.remove('beating'), 200);

            if (sessionReadings.length > 0) {
                document.getElementById('avgVal').innerText = Math.round(sessionReadings.reduce((a,b) => a+b, 0) / sessionReadings.length);
            }
            document.getElementById('stabilityVal').innerText = stabilityCounter + "%";
        }

        function drawGraph() {
            let w = graphCanvas.width, h = graphCanvas.height;
            graphCtx.clearRect(0, 0, w, h);
            graphCtx.strokeStyle = "#c2185b"; // ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏°
            graphCtx.lineWidth = 3;
            graphCtx.lineCap = "round";
            graphCtx.lineJoin = "round";
            graphCtx.beginPath();
            let step = w / 100;
            for (let i = 0; i < signalBuffer.length; i++) {
                let y = h - (signalBuffer[i] * h * 0.7) - 10;
                if (i===0) graphCtx.moveTo(0, y); else graphCtx.lineTo(i * step, y);
            }
            graphCtx.stroke();
        }
    </script>
</body>
</html>
