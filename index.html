<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal Pulse Average</title>
    <style>
        :root { --primary: #00e5ff; --bg: #0d0d0d; --panel: #1a1a1a; --text: #ffffff; }
        body { 
            background: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            height: 100vh; overflow: hidden; user-select: none;
        }

        /* UI Components */
        .header { margin-top: 20px; text-align: center; }
        .title { font-size: 20px; font-weight: 800; color: var(--primary); letter-spacing: 1px; text-transform: uppercase; }
        .subtitle { font-size: 12px; color: #888; }

        .monitor-box {
            position: relative; width: 280px; height: 280px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: radial-gradient(circle, #222 0%, #000 70%);
            border-radius: 50%;
            border: 4px solid #333;
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.1);
        }

        .bpm-display { font-size: 90px; font-weight: 700; line-height: 1; text-shadow: 0 0 15px var(--primary); }
        .bpm-unit { font-size: 16px; color: #aaa; margin-top: 5px; }
        
        /* Stats Panel */
        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 90%; margin-bottom: 20px;
        }
        .stat-card {
            background: var(--panel); padding: 15px; border-radius: 12px;
            text-align: center; border: 1px solid #333;
        }
        .stat-value { font-size: 24px; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 12px; color: #888; margin-top: 2px; }

        /* Graph */
        .graph-container {
            width: 100%; height: 80px; background: #000;
            border-top: 1px solid #333; border-bottom: 1px solid #333;
            position: relative;
        }
        canvas { width: 100%; height: 100%; display: block; }

        /* Controls */
        .btn-container { width: 100%; padding: 20px; box-sizing: border-box; background: #111; border-top-left-radius: 20px; border-top-right-radius: 20px; }
        .btn {
            width: 100%; padding: 18px; font-size: 18px; font-weight: bold;
            border: none; border-radius: 12px; cursor: pointer;
            background: var(--primary); color: #000;
            box-shadow: 0 4px 15px rgba(0, 229, 255, 0.3);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn.stop { background: #ff4757; color: white; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3); }

        /* Hidden Video */
        video { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
        
        /* Animation */
        .beat { animation: pump 0.15s ease-out; }
        @keyframes pump { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div class="header">
        <div class="title">Pulse Average AI</div>
        <div class="subtitle">Universal Web Monitor</div>
    </div>

    <div class="monitor-box">
        <div id="bpmVal" class="bpm-display">--</div>
        <div class="bpm-unit">BPM (Real-time)</div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div id="avgVal" class="stat-value">--</div>
            <div class="stat-label">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (AVG)</div>
        </div>
        <div class="stat-card">
            <div id="confidenceVal" class="stat-value">0%</div>
            <div class="stat-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£</div>
        </div>
    </div>

    <div class="graph-container">
        <canvas id="graphCanvas"></canvas>
    </div>

    <div class="btn-container">
        <button id="actionBtn" class="btn" onclick="toggleMeasure()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏î (START)</button>
    </div>

    <video id="video" playsinline></video>

    <script>
        let video = document.getElementById('video');
        let canvas = document.createElement('canvas');
        let ctx = canvas.getContext('2d', { willReadFrequently: true });
        let graphCanvas = document.getElementById('graphCanvas');
        let graphCtx = graphCanvas.getContext('2d');
        
        let isRunning = false;
        let animationFrame;
        
        // Data Storage
        let signalBuffer = new Array(100).fill(0.5);
        let bpmHistory = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ BPM ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
        let sessionReadings = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
        let lastBeatTime = 0;
        
        // Algorithm Vars
        let minVal = 0, maxVal = 0;
        let stabilityCounter = 0;

        // Resize Handling
        function resize() {
            graphCanvas.width = graphCanvas.offsetWidth;
            graphCanvas.height = graphCanvas.offsetHeight;
        }
        window.onresize = resize;
        resize();

        async function toggleMeasure() {
            let btn = document.getElementById('actionBtn');
            
            if (!isRunning) {
                // --- START ---
                try {
                    let stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: "environment", width: { ideal: 150 }, height: { ideal: 150 } }
                    });
                    video.srcObject = stream;
                    await video.play();

                    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ü‡∏•‡∏ä (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    try {
                        let track = stream.getVideoTracks()[0];
                        await track.applyConstraints({ advanced: [{ torch: true }] });
                    } catch(e) {}

                    isRunning = true;
                    btn.innerText = "‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (STOP)";
                    btn.classList.add('stop');
                    
                    // Reset Values
                    bpmHistory = [];
                    sessionReadings = [];
                    document.getElementById('bpmVal').innerText = "--";
                    document.getElementById('avgVal').innerText = "--";
                    document.getElementById('confidenceVal').innerText = "0%";
                    
                    loop();
                } catch (err) {
                    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô Browser Settings\n(Error: " + err.message + ")");
                }
            } else {
                // --- STOP & SUMMARIZE ---
                stopCamera();
                summarizeResult();
            }
        }

        function stopCamera() {
            isRunning = false;
            cancelAnimationFrame(animationFrame);
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(t => t.stop());
                video.srcObject = null;
            }
            let btn = document.getElementById('actionBtn');
            btn.innerText = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà (START)";
            btn.classList.remove('stop');
        }

        function summarizeResult() {
            let finalAvg = "--";
            if (sessionReadings.length > 5) {
                // ‡∏ï‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏≠‡∏≠‡∏Å (Trim Outliers)
                sessionReadings.sort((a,b) => a-b);
                let validData = sessionReadings.slice(2, -2); // ‡∏ï‡∏±‡∏î 2 ‡∏Ñ‡πà‡∏≤‡∏ö‡∏ô‡πÅ‡∏•‡∏∞ 2 ‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏á
                if (validData.length > 0) {
                    let sum = validData.reduce((a,b) => a+b, 0);
                    finalAvg = Math.round(sum / validData.length);
                }
            }
            alert(`üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î\n\n‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: ${finalAvg} BPM\n\n(‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î ${sessionReadings.length} ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)`);
            document.getElementById('avgVal').innerText = finalAvg;
        }

        function loop() {
            if (!isRunning) return;

            // 1. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏µ
            canvas.width = 40; canvas.height = 40;
            ctx.drawImage(video, 0, 0, 40, 40);
            let frame = ctx.getImageData(15, 15, 10, 10); // Center crop 10x10
            let data = frame.data;
            let totalRed = 0;
            
            for (let i = 0; i < data.length; i += 4) {
                totalRed += data[i];
            }
            let avgRed = totalRed / (data.length / 4);

            // 2. Process Signal
            if (minVal === 0) { minVal = avgRed; maxVal = avgRed; }
            minVal = Math.min(minVal, avgRed);
            maxVal = Math.max(maxVal, avgRed);
            
            // Auto-Gain Recovery
            minVal += 0.5; maxVal -= 0.5;
            
            let range = Math.max(1, maxVal - minVal);
            let normalized = (avgRed - minVal) / range;
            let inverted = 1.0 - normalized; // Pulse = Darker

            // Update Graph
            signalBuffer.push(inverted);
            if (signalBuffer.length > 100) signalBuffer.shift();
            drawGraph();

            // 3. Peak Detection
            if (inverted > 0.60) { // Threshold
                let now = Date.now();
                if (now - lastBeatTime > 300) { // Debounce 300ms
                    let interval = (now - lastBeatTime) / 1000;
                    lastBeatTime = now;
                    let bpm = 60 / interval;

                    if (bpm > 45 && bpm < 200) {
                        updateStats(Math.round(bpm));
                        // Beat Effect
                        document.querySelector('.monitor-box').classList.add('beat');
                        setTimeout(() => document.querySelector('.monitor-box').classList.remove('beat'), 100);
                    }
                }
            }

            animationFrame = requestAnimationFrame(loop);
        }

        function updateStats(bpm) {
            // Smooth BPM (Running Average of last 5)
            bpmHistory.push(bpm);
            if (bpmHistory.length > 5) bpmHistory.shift();
            let smoothBPM = Math.round(bpmHistory.reduce((a,b) => a+b, 0) / bpmHistory.length);
            
            // Show Current
            document.getElementById('bpmVal').innerText = smoothBPM;
            
            // Add to Session (for Final Average) - ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡πà‡∏á‡πÜ
            if (bpmHistory.length >= 5) {
                sessionReadings.push(smoothBPM);
                stabilityCounter = Math.min(100, stabilityCounter + 5);
            } else {
                stabilityCounter = Math.max(0, stabilityCounter - 2);
            }
            
            // Real-time Average Calculation
            if (sessionReadings.length > 0) {
                let sum = sessionReadings.reduce((a,b) => a+b, 0);
                document.getElementById('avgVal').innerText = Math.round(sum / sessionReadings.length);
            }
            
            document.getElementById('confidenceVal').innerText = stabilityCounter + "%";
        }

        function drawGraph() {
            let w = graphCanvas.width;
            let h = graphCanvas.height;
            graphCtx.clearRect(0, 0, w, h);
            graphCtx.strokeStyle = "#00e5ff";
            graphCtx.lineWidth = 2;
            graphCtx.beginPath();
            
            let step = w / 100;
            for (let i = 0; i < signalBuffer.length; i++) {
                let y = h - (signalBuffer[i] * h * 0.8) - (h * 0.1);
                if (i===0) graphCtx.moveTo(0, y);
                else graphCtx.lineTo(i * step, y);
            }
            graphCtx.stroke();
        }
    </script>
</body>
</html>
